---
import { cn } from '@/theme/lib/utils'

interface Props {
  className?: string
  url: string
  alt?: string
}

const { className, url, alt } = Astro.props;
---

<script>
class AvatarComponent extends HTMLElement {
  showAlt = true

  connectedCallback() {
    const img = this.querySelector('img')

    if (img) {
      img.onerror = () => {
        this.showAlt = true
        this.updateVisibility()
      }
      img.onload = () => {
        this.showAlt = false
        this.updateVisibility()
      }
    }

    this.updateVisibility()
  }

  updateVisibility() {
    const placeholderDiv = this.querySelector('.placeholder')
    const imgDiv = this.querySelector('.avatar.absolute')

    if (placeholderDiv) {
      placeholderDiv.classList.toggle('invisible', !this.showAlt)
    }
    if (imgDiv) {
      imgDiv.classList.toggle('invisible', this.showAlt)
      imgDiv.classList.toggle('visible', !this.showAlt)
    }
  }
}

customElements.define('avatar-component', AvatarComponent)
</script>

<avatar-component class="relative select-none">
  <div class={cn('avatar placeholder', 'visible')}>
    <div class={className}>
      {alt}
    </div>
  </div>
  <div class={cn('avatar absolute top-0 left-0 invisible')}>
    <div class={className}>
      <img src={url} alt={alt} loading="lazy" />
    </div>
  </div>
</avatar-component>
